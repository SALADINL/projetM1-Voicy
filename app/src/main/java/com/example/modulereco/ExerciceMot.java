package com.example.modulereco;

import android.content.Context;
import android.os.Environment;
import android.util.Log;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.Random;
import java.util.Scanner;

/**
 * @author Ken Bres
 *
 * Classe permettant de faire des exercices de type lecture de mot.
 */
public class ExerciceMot extends Exercice
{
	private ArrayList<Mot> mots;

	/**
	 * Constructeur vide. Crée un exercice de 50 mots.
	 *
	 * @param context Le contexte dans lequel sera utilisé l'exercice.
	 */
	public ExerciceMot(Context context)
	{
		super(context);

		max = 50;
		mots = new ArrayList<>();
		dico = new File(assetsDir, "mots.dict");

		init(dico);
	}

	/**
	 * Constructeur avec taille variable.
	 *
	 * @param nb 		Le nombre de mots de l'exercice.
	 * @param context 	Le contexte dans lequel sera utilisé l'exercice.
	 */
	public ExerciceMot(int nb, Context context)
	{
		super(context);

		max = nb;
		mots = new ArrayList<>();
		dico = new File(assetsDir, "mots.dict");

		init(dico);
	}

	/**
	 * @author Ahmet AGBEKTAS
	 *
	 * Constructeur permettant de charger une liste de mots prédéfinis.
	 *
	 * @param nb 			Le nombre d'éléments (mots).
	 * @param numeroListes 	Le numéro de liste choisie
	 * @param context 		Le contexte dans lequel sera utilisé l'exercice.
	 */
	public ExerciceMot(int nb, int numeroListes, Context context)
	{
		super(context);

		max = nb;
		mots = new ArrayList<>();
		String filepath = Environment.getExternalStorageDirectory().getPath();
		int num = numeroListes + 1;
		dico = new File(filepath, "/ModuleReco/Listes/Liste" + num);
		System.out.println("dico : " + dico);

		initAvecListe(dico);
	}


	/*
	ADEL
	 */
	public ExerciceMot(String mot, Context context)
	{
		super(context);

        max = 1;
		mots = new ArrayList<>();
		String filepath = context.getAssets().toString();
		dico = new File(assetsDir, "/mots.dict");
		Log.d("abcdef", "Path " + dico);


	}

	public boolean initMultiPhoneme(String mot)
	{
		return initAvecListeMultiPhoneme(dico, mot);
	}

	public boolean initAvecListeMultiPhoneme(File f, String mot)
	{
		boolean findMot = false;

		mots.clear();

		String[] res = null;

		try (BufferedReader br = new BufferedReader(new FileReader(f)))
		{
			String line;
			while ((line = br.readLine()) != null)
			{
				if(line.contains(mot))
				{
					res = line.split("\t");


					Mot leMot = new Mot(res[0], res[1]);
					Log.d("abcdef", "Mot = " + leMot.getMot());
					Log.d("abcdef", "Prononciation = " + leMot.getPrononciation());
					mots.add(leMot);

					findMot = true;

					break;
				}
			}
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}

		if(!findMot)
		{
			return false;
		}

		updateJsgf();

		return true;


	}

	/**
	 * @author Ahmet AGBEKTAS
	 *
	 * Copie des mots contenus dans le fichier liste dans l'exercice.
	 *
	 * @param f Fichier qui contient la liste des non-mots
	 */
	public void initAvecListe(File f)
	{
		mots.clear();

		String[] res = null;

		try (BufferedReader br = new BufferedReader(new FileReader(f)))
		{
			String line;
			while ((line = br.readLine()) != null)
			{
				res = line.split("\t");


                Mot leMot = new Mot(res[0], res[1]);
                Log.d("abcdef", "Mot = " + leMot.getMot());
				Log.d("abcdef", "Prononciation = " + leMot.getPrononciation());
				mots.add(leMot);
			}
		}
		catch (Exception e)
		{
			e.printStackTrace();
		}

		updateJsgf();
	}

	/**
	 * Lecture aléatoire du dictionnaire de non-mots. N'autorise pas les doublons.
	 *
	 * @param f Fichier qui contient les non-mots
	 */
	public void init(File f)
	{
		mots.clear();

		try
		{
			for (int i = 0; i < max; i++)
			{
				String[] res = null;
				boolean pasok = false;

				do
				{
					res = getMotRandom(f).split("\t");

					for (int j = 0; j < mots.size(); j++)
						if (mots.get(j).getMot().equals(res[0]))
						{
							pasok = true;
							break;
						}

				} while (pasok);

				Mot leMot = new Mot(res[0], res[1]);
				mots.add(leMot);
			}

			updateJsgf();
		}
		catch (FileNotFoundException e)
		{
			System.out.println(e.getStackTrace());
		}
	}

	/**
	 * Récupère un mot aléatoire dans un dictionnaire
	 *
	 * @param f Le dictionnaire.
	 * @return Le mot choisi.
	 */
	private static String getMotRandom(File f) throws FileNotFoundException
	{
		String result = null;
		Random rand = new Random();
		int n = 0;

		for(Scanner sc = new Scanner(f); sc.hasNext();)
		{
			++n;
			String line = sc.nextLine();
			if(rand.nextInt(n) == 0)
				result = line;
		}

		return result;
	}

	/**
	 * Retourne le texte à prononcer du mot courant.
	 *
	 * @return le mot à prononcer.
	 */
	public String getText()
	{
		return mots.get(index).getMot();
	}

	/**
	 * Met à jour le fichier JSGF.
	 */
	protected void updateJsgf()
	{
		updateAlignJsgf();
		updateWordJsgf();
	}

	/**
	 * Met à jour le JSGF pour l'alignement par phonème.
	 */
	private void updateAlignJsgf()
	{
		File f = null;
		String tmp = mots.get(index).getAlignFormat();
		BufferedWriter output = null;

		try
		{
			f = new File(assetsDir, "mot-align.jsgf");
			output = new BufferedWriter(new FileWriter(f));
			output.write(tmp);
			output.close();
		}
		catch (IOException e)
		{
			e.printStackTrace();
		}
	}

	/**
	 * Met à jour le JSGF pour l'alignement par mot.
	 */
	public void updateWordJsgf()
	{
		File f = null;
		String tmp = mots.get(index).getWordFormat();
		BufferedWriter output = null;

		try
		{
			f = new File(assetsDir, "mot-word.jsgf");
			output = new BufferedWriter(new FileWriter(f));
			output.write(tmp);
			output.close();
		}
		catch (IOException e)
		{
			e.printStackTrace();
		}
	}
}